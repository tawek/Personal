<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Irregular Verbs Game</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        html, body {
            margin: 0;
            height: 100%;
            overflow: hidden;
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(45deg, #ffb6c1, #add8e6);
        }
        .container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
        }
        .game-box {
            background: #fff8dc;
            border: 4px dashed #ff69b4;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 0 20px #ff69b4;
            text-align: center;
            width: 80%;
            max-width: 500px;
            position: relative;
        }
        h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        .word {
            font-size: 2em;
            margin-bottom: 10px;
            color: #ff1493;
        }
        .inputs input {
            font-size: 1.2em;
            margin: 10px;
            padding: 5px 10px;
            border-radius: 10px;
            border: 2px solid #aaa;
        }
        .inputs i {
            cursor: pointer;
            color: #007BFF;
            margin-left: 10px;
        }
        .correct { border-color: green; }
        .wrong { border-color: red; }
        .score {
            margin-top: 10px;
            font-weight: bold;
            font-size: 1.5em;
            color: #444;
        }
        .trophy {
            font-size: 4em;
            color: gold;
            animation: pop 1s infinite alternate;
        }
        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border: 5px solid #ff0000;
            border-radius: 15px;
            z-index: 999;
            text-align: center;
            font-size: 1.5em;
            box-shadow: 0 0 30px red;
            display: none;
        }
        .spark {
            position: absolute;
            width: 10px;
            height: 10px;
            background: gold;
            border-radius: 50%;
            animation: sparkle 1s linear forwards;
        }
        @keyframes sparkle {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(3); opacity: 0; top: -100px; }
        }
        @keyframes shake {
            0%, 100% { transform: translate(0); }
            20%, 60% { transform: translate(-10px); }
            40%, 80% { transform: translate(10px); }
        }
        .shake {
            animation: shake 0.5s;
        }
        .music-btn {
            display: none;
        }
        .music-icon {
            font-size: 1.2em;
            margin-left: 8px;
            vertical-align: middle;
            transition: filter 0.2s;
        }
        .music-icon.stopped {
            filter: grayscale(1) brightness(0.7);
            opacity: 0.5;
        }
        .music-icon:hover {
            filter: brightness(1.5);
        }
        .submit-btn {
            margin-top: 18px;
            font-size: 1.4em;
            padding: 16px 44px;
            border-radius: 18px;
            border: none;
            background: linear-gradient(90deg, #ff69b4 40%, #ffd700 100%);
            color: #fff;
            font-weight: bold;
            box-shadow: 0 4px 18px #ffb6c1;
            cursor: pointer;
            transition: transform 0.08s, box-shadow 0.08s;
        }
        .submit-btn:active {
            transform: scale(0.93);
            box-shadow: 0 2px 8px #ffb6c1;
        }
        .cover-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #ff9a9e, #67b8de);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .cover-title {
            font-size: 3.5em;
            color: white;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
            margin-bottom: 30px;
        }
        .start-button {
            padding: 20px 60px;
            font-size: 2em;
            background: #fff;
            border: none;
            border-radius: 50px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            color: #ff69b4;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .start-button:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        .start-button:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body>
<div class="cover-overlay" id="coverOverlay">
    <div class="cover-title">Welcome to Verb Hero!</div>
    <button class="start-button" id="startBtn">Start Game</button>
</div>
<div class="container" style="display:none;" id="gameContainer">
    <div class="game-box" id="gameBox">
        <h1>
            üé® Verb Hero
            <span id="musicToggleBtn" class="music-icon" title="Stop Music" style="cursor:pointer;">üé∂</span>
        </h1>
        <div class="word" id="verb">Loading... <i class="fas fa-volume-up" onclick="speak('verb')"></i></div>
        <div class="inputs">
            <input type="text" id="past" placeholder="Past Simple" />
            <i class="fas fa-volume-up" onclick="speak('past')"></i><br />
            <input type="text" id="participle" placeholder="Past Participle" />
            <i class="fas fa-volume-up" onclick="speak('participle')"></i>
        </div>
        <button id="submitBtn" class="submit-btn" onclick="check()">Submit</button>
        <div id="scoreDisplay" class="score">Score: 0</div>
    </div>
</div>
<div class="modal" id="modal"></div>
<audio id="failSound" src="puzzle-error.mp3"></audio>
<audio id="successSound" src="success-sound.mp3"></audio>
<audio id="bgMusic" src="peaceful-soundscape.mp3" loop></audio>
<script>
    // Define game data and variables
    const verbs = [
        ["be", "was/were", "been"], ["become", "became", "become"], ["begin", "began", "begun"],
        ["bring", "brought", "brought"], ["build", "built", "built"], ["buy", "bought", "bought"],
        ["catch", "caught", "caught"], ["choose", "chose", "chosen"], ["come", "came", "come"],
        ["cost", "cost", "cost"], ["cut", "cut", "cut"], ["do", "did", "done"], ["draw", "drew", "drawn"],
        ["drink", "drank", "drunk"], ["drive", "drove", "driven"], ["eat", "ate", "eaten"],
        ["fall", "fell", "fallen"], ["feed", "fed", "fed"], ["feel", "felt", "felt"], ["fight", "fought", "fought"],
        ["find", "found", "found"], ["fly", "flew", "flown"], ["forget", "forgot", "forgotten"],
        ["get", "got", "gotten"], ["give", "gave", "given"], ["go", "went", "gone"],
        ["have", "had", "had"], ["hear", "heard", "heard"], ["keep", "kept", "kept"],
        ["know", "knew", "known"], ["learn", "learned", "learned"], ["leave", "left", "left"],
        ["let", "let", "let"]
    ];

    // List of positive utterances
    const successUtterances = [
        "Good job!", "Yes!", "Correct!", "Awesome!", "Well done!", "You got it!", "Fantastic!",
        "Brilliant!", "Superb!", "Excellent!", "That's right!", "Way to go!", "Nice work!",
        "You nailed it!", "Great answer!", "Keep it up!", "Impressive!", "You rock!",
        "Spot on!", "Marvelous!", "Outstanding!", "Perfect!", "That's the spirit!",
        "You're on fire!", "Bingo!", "You aced it!", "Crushed it!", "Magnificent!",
        "You're unstoppable!", "Legendary!", "You're a star!", "That's genius!",
        "You're amazing!", "You're a champ!", "You're a natural!", "You're incredible!",
        "You're a winner!", "You're a pro!", "You're a master!", "You're a wizard!",
        "You're a hero!", "You're a superstar!", "You're a legend!", "You're a whiz!",
        "You're a marvel!", "You're a virtuoso!", "You're a champion!", "You're a powerhouse!",
        "You're a dynamo!", "You're a rockstar!"
    ];

    // Get DOM references
    const coverOverlay = document.getElementById("coverOverlay");
    const gameContainer = document.getElementById("gameContainer");
    const startBtn = document.getElementById("startBtn");

    // Start button click handler - all game initialization happens here
    startBtn.onclick = function() {
        // Hide overlay and show game
        coverOverlay.style.display = 'none';
        gameContainer.style.display = 'flex';

        // Initialize the game after user interaction
        initGame();
    };

    // All game logic contained in this function - only called after user interaction
    function initGame() {
        console.debug("[App] Initializing app logic after user interaction...");

        // Initialize variables
        let score = 0;
        let current = [];
        const mistakes = new Map();
        const lastFive = [];
        let enVoice = null;
        let musicPlaying = true;

        // Get DOM elements
        const verbEl = document.getElementById("verb");
        const scoreDisplay = document.getElementById("scoreDisplay");
        const pastInput = document.getElementById("past");
        const partInput = document.getElementById("participle");
        const modal = document.getElementById("modal");
        const gameBox = document.getElementById("gameBox");
        const musicToggleBtn = document.getElementById("musicToggleBtn");
        const submitBtn = document.getElementById("submitBtn");
        const bgMusic = document.getElementById("bgMusic");

        // Load voices - should work immediately after user interaction
        loadVoice();

        // Initialize first verb and start the game
        update();

        // Start background music (will work because user has interacted)
        bgMusic.volume = 0.5;
        bgMusic.play().catch(e => console.warn("[Audio] Music autoplay failed:", e));

        // Set up music toggle
        musicToggleBtn.onclick = function() {
            if (musicPlaying) {
                bgMusic.pause();
                musicToggleBtn.title = "Play Music";
                musicToggleBtn.classList.add("stopped");
            } else {
                bgMusic.play();
                musicToggleBtn.title = "Stop Music";
                musicToggleBtn.classList.remove("stopped");
            }
            musicPlaying = !musicPlaying;
        };

        // Add debug for speech icon clicks
        document.querySelectorAll('.fa-volume-up').forEach(icon => {
            icon.addEventListener('click', (e) => {
                console.debug("[Speech] Volume icon clicked.", e.target);
            });
        });

        // Add push animation to submit button
        submitBtn.addEventListener("click", function() {
            submitBtn.classList.add("submit-btn-push");
            setTimeout(() => submitBtn.classList.remove("submit-btn-push"), 120);
        });

        // Expose functions to global scope for inline handlers
        window.speak = speak;
        window.check = check;

        // CORE FUNCTIONS

        function loadVoice() {
            const voices = speechSynthesis.getVoices();
            console.debug("[Speech] Available voices:", voices);
            enVoice = voices.find(v => v.lang.startsWith('en') && v.localService)
                || voices.find(v => v.lang.startsWith('en'));

            if (enVoice) {
                console.debug("[Speech] Selected English voice:", enVoice);
            } else {
                console.warn("[Speech] No English voice found!");

                // If voices aren't loaded immediately, listen for the voiceschanged event
                speechSynthesis.onvoiceschanged = function() {
                    const voices = speechSynthesis.getVoices();
                    enVoice = voices.find(v => v.lang.startsWith('en') && v.localService)
                        || voices.find(v => v.lang.startsWith('en'));
                    console.debug("[Speech] Voices loaded on change event. Selected voice:", enVoice);
                };
            }
        }

        function chooseVerb() {
            const pool = verbs.flatMap(v => Array(mistakes.get(v[0]) || 1).fill(v));
            let pick;
            do {
                pick = pool[Math.floor(Math.random() * pool.length)];
            } while (lastFive.includes(pick[0]));
            lastFive.push(pick[0]);
            if (lastFive.length > 5) lastFive.shift();
            return pick;
        }

        function update() {
            current = chooseVerb();
            verbEl.innerHTML = `${current[0]} <i class='fas fa-volume-up' onclick="speak('verb')"></i>`;
            // Now it's safe to auto-speak after user interaction
            speak('verb');
        }

        function speak(field) {
            let txt;
            if (field === 'past') txt = pastInput.value;
            else if (field === 'participle') txt = partInput.value;
            else txt = current[0];

            console.debug(`[Speech] speak('${field}') called. Text: "${txt}"`);
            if (!txt) {
                console.warn("[Speech] No text to speak for field:", field);
                return;
            }
            if (!('speechSynthesis' in window)) {
                console.error("[Speech] speechSynthesis API not available in this browser.");
                return;
            }

            const utterance = new SpeechSynthesisUtterance(txt);
            utterance.lang = 'en-US';
            if (enVoice) {
                utterance.voice = enVoice;
                console.debug("[Speech] Using voice:", enVoice);
            } else {
                console.warn("[Speech] No English voice set for utterance.");
            }

            utterance.onerror = (e) => {
                console.error("[Speech] Utterance error:", e);
            };
            utterance.onstart = () => {
                console.debug("[Speech] Utterance started.");
            };
            utterance.onend = () => {
                console.debug("[Speech] Utterance ended.");
            };

            speechSynthesis.speak(utterance);
        }

        function speakAll(msg, rate = 1) {
            console.debug(`[Speech] speakAll() called. Text: "${msg}", Rate: ${rate}`);
            if (!('speechSynthesis' in window)) {
                console.error("[Speech] speechSynthesis API not available in this browser.");
                return;
            }

            const utterance = new SpeechSynthesisUtterance(msg);
            utterance.lang = 'en-US';
            utterance.rate = rate;
            if (enVoice) {
                utterance.voice = enVoice;
                console.debug("[Speech] Using voice:", enVoice);
            } else {
                console.warn("[Speech] No English voice set for utterance.");
            }

            utterance.onerror = (e) => {
                console.error("[Speech] Utterance error:", e);
            };
            utterance.onstart = () => {
                console.debug("[Speech] Utterance started.");
            };
            utterance.onend = () => {
                console.debug("[Speech] Utterance ended.");
            };

            speechSynthesis.speak(utterance);
        }

        function showModal(msg) {
            modal.textContent = msg;
            modal.style.display = 'block';
            speakAll(msg, 0.5); // slower for failures
            setTimeout(() => {
                modal.style.display = 'none';
                pastInput.disabled = false;
                partInput.disabled = false;
                pastInput.focus();
            }, 5000);
        }

        function showSuccessModal() {
            // 1. Success sound has already played in the check() function

            // 2. Say the three forms of the verb before showing congratulatory message
            const verbForms = `${current[0]}, ${current[1]}, ${current[2]}`;
            console.debug("[Speech] Speaking verb forms:", verbForms);

            // Create a promise that resolves when the utterance finishes
            const speakVerbFormsPromise = new Promise((resolve) => {
                const utterance = new SpeechSynthesisUtterance(verbForms);
                utterance.lang = 'en-US';
                if (enVoice) {
                    utterance.voice = enVoice;
                }
                utterance.rate = 0.9; // Slightly slower to emphasize the verb forms
                utterance.onend = resolve;
                utterance.onerror = resolve; // Also resolve on error to prevent hanging
                speechSynthesis.speak(utterance);
            });

            // 3. After verb forms are spoken, show congratulatory message
            speakVerbFormsPromise.then(() => {
                // Pick a random utterance for congratulation
                const utter = successUtterances[Math.floor(Math.random() * successUtterances.length)];
                modal.textContent = utter;
                modal.style.display = 'block';

                // Create a promise that resolves when congratulatory utterance finishes
                const speakCongratulationsPromise = new Promise((resolve) => {
                    const utterance = new SpeechSynthesisUtterance(utter);
                    utterance.lang = 'en-US';
                    if (enVoice) {
                        utterance.voice = enVoice;
                    }
                    utterance.onend = resolve;
                    utterance.onerror = resolve; // Also resolve on error to prevent hanging
                    speechSynthesis.speak(utterance);
                });

                // 4. After congratulatory utterance finishes, close modal and update for next word
                speakCongratulationsPromise.then(() => {
                    setTimeout(() => {
                        modal.style.display = 'none';
                        pastInput.value = "";
                        partInput.value = "";
                        update(); // Call update only after modal closes
                    }, 500); // Small delay after speech finishes before moving on
                });
            });
        }

        function addSparkles() {
            for (let i = 0; i < 10; i++) {
                const spark = document.createElement('div');
                spark.className = 'spark';
                spark.style.left = `${Math.random() * 100}%`;
                spark.style.top = `${Math.random() * 100}%`;
                document.body.appendChild(spark);
                setTimeout(() => spark.remove(), 1000);
            }
        }

        function check() {
            const past = pastInput.value.trim().toLowerCase();
            const part = partInput.value.trim().toLowerCase();
            const correctPast = current[1].toLowerCase();
            const correctPart = current[2].toLowerCase();
            const pastOk = past === correctPast;
            const partOk = part === correctPart;

            if (pastOk && partOk) {
                score++;
                scoreDisplay.textContent = `Score: ${score}`;
                addSparkles();
                // Play success sound
                const successSound = document.getElementById("successSound");
                successSound.currentTime = 0;
                successSound.play();
                showSuccessModal();
                if (score >= 50) {
                    document.body.innerHTML = `<h1>üèÜ Congratulations!</h1><div class='trophy'>üèÜ</div><p>You mastered the verbs!</p>`;
                    return;
                }
                pastInput.value = "";
                partInput.value = "";
            } else {
                score--;
                scoreDisplay.textContent = `Score: ${score}`;
                pastInput.disabled = true;
                partInput.disabled = true;
                const failSound = document.getElementById("failSound");
                failSound.play();
                gameBox.classList.add("shake");
                setTimeout(() => {
                    pastInput.disabled = false;
                    partInput.disabled = false;
                    pastInput.focus();
                }, 1000);
                setTimeout(() => gameBox.classList.remove("shake"), 500);
                document.body.style.background = '#556b2f';
                setTimeout(() => document.body.style.background = 'linear-gradient(45deg, #ffb6c1, #add8e6)', 600);
                setTimeout(() => showModal(`${current[0]}, ${current[1]}, ${current[2]}`), 2000);
                mistakes.set(current[0], (mistakes.get(current[0]) || 1) + 1);
            }
        }
    }
</script>
</body>
</html>